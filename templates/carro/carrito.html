{% extends "plantilla_tienda.html" %}
{% load static %}
{% block carro %}
{% load carrito %}
{% if user.is_authenticated %}
<div class="container">
    <div class="row justify-content-start ">
        <div class="d-inline mi_lista_menu1 pt-3">
            {% if datos_para_imagen.imagen %}
                <img  src="/media/{{datos_para_imagen.imagen}}"    alt="{{usuario.nombre}}" class="img-thumbnail" style="width:50px; height: auto;"/>
            {% else %}
                <img  src="/media/usuario/defecto.png"    alt="{{usuario.nombre}}" class="img-thumbnail" style="width:50px; height: auto;"/>
            {% endif %}
        </div>
        <div class="d-inline mi_lista_menu1 pt-3">
            <h3>&nbsp;&nbsp;Hola:&nbsp; {{request.user}}</h3>
        </div>
    </div>
</div>
{% endif %}
<div class="container">
    <div class="col-12    rounded p-4 m-4">
        <div class="d-flex justify-content-around">
            <div>        
                <a class="navbar-brand mb-3" href="{% url 'tienda'  %}">
                    <button type="button" class="btn btn-success btn-lg" style="width:100%; border-radius: 10px;">
                        Ir a tienda
                    </button>
                </a>
            </div>
        
            <div>
                {% if user.is_authenticated %}
                <a href="{% url 'perfil_paso1'  %}" class="btn btn-success btn-lg" style="border-radius: 10px;">
                    Finalizar Compra
                </a>
                {% else %}
                <button type="button" class="btn btn-warning btn-lg" style="border-radius: 10px;" data-bs-toggle="modal" data-bs-target="#myModal">
                    Comprar
                </button>
                {% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-between">
            <br/> 
        </div>
        <!-- *******************************************************
        *   PRODUCTOS **********************************************
        *********************************************************-->
        <form class="row form_talle">
            {% for producto in los_productos %}
            <div class="col-12 col-lg-6 col-xl-4 prod_selec pt-4">
                <div class ="row ver_stock">
                    <div class="row">
                        <div class="col-12">
                            <center>
                                <h4  >{{producto.nombre}}</h4>
                            </center> 
                        </div>
                        <!-- *****************************************************
                        * IMAGEN
                        *******************************************************-->
                        <div class="col-9">
                            <div class="col-12">
                                <a href="{% url 'ver_producto' articulo=producto.articulo %}"  >
                                    <img style="width:100%;"   src="{{producto.imagen.url}}"/>
                                </a>
                            </div>
                        </div>
                        <!-- *****************************************************
                        * RESTO
                        *******************************************************-->
                        <div class="col-3">
                            <div class="d-inline text-center col-12 pt-1"  >
                                <center>
                                <span><b>Precio</b></span>    
                                    {{producto.precio}}
                                </center>   
                            </div>    
                            <div class="d-inline text-center col-12 pt-1"  >
                                <center>
                                    <span><b>Cantidad</b></span>
                                    <div id="prestige_{{producto.id}}" class="car-footer p-0 row no-gutters form-group ">
                                        <input type="submit" value="-" class="  btn  btn-outline-dark btn-sm quitar" />
                                        <input type="text"   class="vervalor form-control-sm text-center " value="{{producto | carro_cantida:request.session.carro}}"/>
                                        <input type="submit" value="+" class="  btn  btn-outline-dark btn-sm agregar" />
                                        <input type="submit"  hidden class="col-12 vervalor" value="0"/>
                                    </div> 
                                </center><br/> 
                            </div>                    
                            <div class="d-inline text-center col-12 pt-1"  >
                                <center>
                                    <span><b>SubTotal</b></span>
                                        {{producto|precio_total_producto:request.session.carro}}  
                                </center>
                            </div>
                            <div class="d-inline text-center col-2 pt-1"  >
                                <center>
                                    <button id = "el{{producto.id}}" class="btn btn-danger eliminar_producto">
                                        <span class="icon-bin"></span>    
                                    </button>
                                </center>
                            </div> 
                        </div>
                    </div>
                </div>
            </div> 
            {% endfor %}

            <div class ="row  ">
                <div class="d-inline text-center col-12 pt-1"  >  
                  <br/><br/>
                </div> 
            </div>
             
      </form>
        <!-- *******************************************************
        *   ------------------------------------------------------
        *********************************************************-->



        <div class="d-inline text-center col-3 pt-1">
            {% with total_final=los_productos|precio_final:request.session.carro %}
                <!-- Mostrar el valor total final para depuración 
                <h5 style="color: darkorange;">Total para comparación: ${{ total_final }}</h5>-->
        
                {% if total_final >= 50000 %}
                    <!-- Mostrar "Envío gratis" si el total es igual o mayor a 51,000 -->
                    <h5 style="color: darkolivegreen;">Costo de Envío: <span style="color: #4caf50;">Envío Gratis</span></h5>
                {% endif %}
                
                <!-- Mostrar el total final con un decimal, estilizado y en grande -->
                <h4 style="font-weight: bold; color: #4caf50; margin-top: 20px;">
                    Total Final: <span style="font-size: 1.5em; color: #ff5722;">${{ los_productos|precio_final:request.session.carro }}</span>
                </h4>
            {% endwith %}
        </div>
    </div>
    </div>
    <div class="d-flex justify-content-center mt-5">
        <div class="card shadow-lg p-4" style="max-width: 500px; border-radius: 15px;">
            <h3 class="text-center text-primary mb-4">Simulador de Costo de Envío</h3>
            <form method="POST" class="form_talle">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="codigo_postal" class="form-label">
                        Ingrese su Código Postal:
                    </label>
                    <input type="text" id="codigo_postal" name="codigo_postal" class="form-control form-control-lg"
                        placeholder="Ej: 1001" required style="border-radius: 10px;">
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg w-100" style="border-radius: 10px;">
                        Calcular Costo Aproximado de Envío
                    </button>
                </div>
                {% if costo_envio %}
                    <div class="mt-4">
                        {% if costo_envio == "No se pudo calcular la distancia." or costo_envio == "Configuración de envío no encontrada." %}
                            <p class="text-danger text-center">{{ costo_envio }}</p>
                        {% else %}
                            <p class="text-success text-center">
                                <b>Cálculo aproximado de Costo de Envío: ${{ costo_envio }}.</b>
                                <br>Ahora podes finalizar tu compra!!. Un asesor comercial se contactará para confirmar el pedido y coordinar el punto de entrega y el precio total. ¡Gracias!
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
<div class="container">
    <!-- The Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
                <div class="modal-content">
                <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title">Para finalizar</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
                    </div>
                    <!-- Modal body -->
                    <div class="modal-body">
                        Registrate antes de seguir y completa los datos de envío. 
                    </div>
                    <!-- Modal footer -->
                    <div class="modal-footer"  >
                        <div class="col-12"  > 
                            <div class ="row justify-content-around"  >
                                <div class="col-4"  >
                                    <a href="{% url 'login' %}">
                                        <button id="login_m" type="button" class="btn btn-danger"  >
                                            Login
                                        </button>
                                    </a>
                                </div>

                                <div class="col-4"  >
                                    <a href="{% url 'registro' %}">
                                        <button id="registrarme_m" type="button" class="btn btn-danger"  >
                                            Registrarme
                                        </button>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>     
                </div>
        </div>
    </div>
</div>  
{% endblock %}
{% block javascript %}
<script src="https://cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.min.js"></script> 
<script type="text/javascript" src="{% static 'js/juan_ajax.js' %}"></script>
<script type="text/javascript" src="{% static 'js/minified/gsap.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/minified/ScrollTrigger.min.js' %}"></script>
 
<script>
$(document).ready(function() {
 $("#MyModal").modal();
});
</script>
<script>
    const burgerLines = document.querySelectorAll('.prod_selec') 
    burgerLines.forEach((prod_dest) => {
      prod_dest.addEventListener('mouseover', (e) => {
        //console.log('The burger is hovered')
        TweenMax.to(prod_dest, 0.2, {
          scaleX:1.05, scaleY:1.05, scaleZ:1.3,
        })
      })
      prod_dest.addEventListener('mouseout', (e) => {
        //console.log('The burger is hovered')
        TweenMax.to(prod_dest, 0.2, {
          scaleX:1, scaleY:1, scaleZ:1,
        })
      }) 
    })
    </script>
{% endblock %}
